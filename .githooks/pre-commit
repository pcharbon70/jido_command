#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(git rev-parse --show-toplevel)"
cd "$ROOT_DIR"

declare -a MIX_CMD=(mix)

ensure_mix_cmd() {
  if command -v "${MIX_CMD[0]}" >/dev/null 2>&1; then
    return
  fi

  echo "[pre-commit] Could not find mix. Install Elixir tooling first." >&2
  exit 1
}

ensure_mix_home() {
  if [ -z "${MIX_HOME:-}" ]; then
    export MIX_HOME="$ROOT_DIR/tmp/precommit_mix_home"
  fi

  mkdir -p "$MIX_HOME"
}

has_hex_archive() {
  find "$MIX_HOME/archives" -maxdepth 1 -type d -name "hex-*" -print -quit 2>/dev/null | grep -q .
}

has_rebar3() {
  find "$MIX_HOME/elixir" -type f -name "rebar3" -print -quit 2>/dev/null | grep -q .
}

ensure_mix_bootstrap() {
  if ! has_hex_archive; then
    echo "[pre-commit] Installing Hex into MIX_HOME..."
    "${MIX_CMD[@]}" local.hex --force >/dev/null
  fi

  if ! has_rebar3; then
    echo "[pre-commit] Installing Rebar into MIX_HOME..."
    "${MIX_CMD[@]}" local.rebar --force >/dev/null
  fi
}

ensure_mix_cmd
ensure_mix_home
ensure_mix_bootstrap

run_check() {
  local label="$1"
  shift
  echo "[pre-commit] Running ${label}..."
  "${MIX_CMD[@]}" "$@"
}

run_check "tests" test
run_check "credo" credo --strict
run_check "dialyzer" dialyzer

echo "[pre-commit] All checks passed."
